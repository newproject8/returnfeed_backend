1. 프로젝트 개요 및 목표
프로젝트 명: ReturnFeed Live (실시간 탈리(Tally) 및 리턴 모니터 시스템)
주요 목적: 1. 실시간 비디오 스트리밍: vMix에서 발행한 PGM (프로그램) 영상 스트림을 WebRTC 기반으로 전달. 2. 초
저지연 탈리 정보: 방송 PD가 vMix에서 생성한 탈리 신호(Tally)를 웹브라우저(WebSocket)로 동기 전달. 3. 클라이언
트 접근성: 별도 앱 설치 없이 PC나 스마트폰 웹브라우저만으로 영상 및 탈리 확인 가능.
핵심 성능 지표: - 스트림 지연 ≤ 100ms - 탈리 전송 지연 ≤ 50ms - 다중 동시 접속자 수: 최소 50명
시스템 구성 요소: 1. 송출단 (PD 측) - vMix: PGM 영상 소스 및 탈리 API 제공 - PD용 Tally Broadcaster 앱
(Python): vMix TCP/HTTP API → WebSocket 중계 서버 2. 서버 측 (Ubuntu/Docker) - Nginx: SSL 종료 및
Reverse Proxy (host 네트워크 모드) - MediaMTX (Docker): SRT 수신 → WebRTC 변환 (WHEP) - Tally Relay
 (Docker): WebSocket 중계 (탈리 정보) - Docker Compose / Portainer 관리 3. 클라이언트 (카메라맨/스태프) 
React SPA (
 tally_test.html ): WebRTC 비디오 플레이어 + WebSocket 탈리 처리
2. 초기 증상 및 문제 정의
2.1 증상 요약
1. 
2. 
3. 
4. 
검은 화면: 
https://returnfeed.net/tally_test.html 접속 시 영상이 전혀 표시되지 않고 검은
화면 또는 ‘연결 실패’ 알림만 반복.
 404 오류: 브라우저 개발자도구 네트워크 탭에서 
POST https://returnfeed.net/pgm_srt_raw
요청이 404 Not Found로 응답.
스마트폰 연결 실패: 와이파이 또는 LTE 환경 모두에서 영상 재생 불가.
 LAN 직접 접속 정상: 동일 네트워크(LAN)에서 서버 호스트의 
http://<공인IP>:8889/pgm_srt_raw/
페이지는 정상 재생.
 2.2 근본 원인 분석
• 
• 
• 
Reverse Proxy 설정 오류: Nginx가 WebRTC WHEP(SDP 교환) 및 WebSocket 경로를 올바르게 매핑하지
못해 컨테이너 내부 서비스로 요청이 전달되지 않음.
 DNS 및 네트워크 모드 오류: Nginx 컨테이너가 host 네트워크 모드임에도 Docker 서비스 이름을
upstream으로 사용하여 호스트 이름 해석 실패.
 SSL 인증서 미설치: 
/etc/letsencrypt 경로 미존재로 인해 SSL 종료(Nginx) 단계에서 컨테이너가 기동
불가.
 3. 상세 아키텍처 & 네트워크 흐름
1
flowchart LR
  subgraph PD_Side
    vMix -->|SRT| MediaMTX
    vMix -->|TCP/HTTP 탈리| TallyBroadcaster
  end
  subgraph Server_Side
    Nginx[nginx (host 네트워크)]
    MediaMTX -->|WebRTC (WHEP)| Nginx
    TallyRelay -->|WebSocket| Nginx
  end
  subgraph Client
    Browser -->|HTTPS| Nginx
    Browser -->|WebRTC| Nginx --> MediaMTX
    Browser -->|WS| Nginx --> TallyRelay
  end- vMix → MediaMTX: SRT 스트림 (포트 8890) → MediaMTX가 WHEP 인터페이스(포트 8889)로 전달 - vMix →
 Tally Relay: Python 앱이 WebSocket(wss://returnfeed.net/ws/)으로 탈리 중계 - Nginx: HTTPS(80 → 443 리
디렉션) → WebRTC/WHEP 요청 → MediaMTX, WS 요청 → Tally Relay
 4. 단계별 문제 해결 절차
4.1 SSL 인증서 설치
1. 
2. 
3. 
4. 
인증서 유무 확인: 
ls/etc/letsencrypt/live/your-domain/{fullchain.pem,privkey.pem}
 Certbot 설치 (Snap 패키지 권장): 
sudoaptupdate&&sudoaptinstallsnapd-y
 sudosnapinstallcore;sudosnaprefreshcore
 sudosnapinstall--classiccertbot
 sudoln-s/snap/bin/certbot/usr/bin/certbot
 Standalone 모드로 인증서 발급 (80 포트 임시 사용): 
sudosystemctlstopnginx # 기존 Nginx 중지
sudodockerrm-fnginx-web-server||true
 sudocertbotcertonly--standalone\-dreturnfeed.net-dwww.returnfeed.net
발급 확인 및 경로: 
2
ls/etc/letsencrypt/live/returnfeed.net/{fullchain.pem,privkey.pem}
 5. 
Nginx 컨테이너 실행: 
dockerrun-d--namenginx-web-server--networkhost\-v~/nginx-web/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro\-v/etc/letsencrypt:/etc/letsencrypt:ronginx:alpine
팁: 인증서 자동 갱신 시 --post-hook 스크립트로 컨테이너를 재시작하도록 설정할 것.
 4.2 Nginx Reverse Proxy 설정 보강
1. 
2. 
3. 
4. 
5. 
6. 
7. 
8. 
WebRTC(WHEP) 경로:
이전 오류: 
proxy_pass http://host.docker.internal:8889;
문제: 요청 경로가 보존되지 않아 
/pgm_srt_raw/whep 엔드포인트로 전달되지 않음.
수정 예시: 
location /pgm_srt_raw {
 proxy_pass http://host.docker.internal:8889/pgm_srt_raw/;
 proxy_http_version 1.1;
 proxy_set_header Upgrade $http_upgrade;
 proxy_set_header Connection "upgrade";
 proxy_set_header Host $host;
 proxy_buffering off;
 }
 location /pgm_srt_raw/whep {
 proxy_pass http://host.docker.internal:8889/pgm_srt_raw/whep;
 proxy_http_version 1.1;
 proxy_set_header Upgrade $http_upgrade;
 proxy_set_header Connection "upgrade";
 proxy_set_header Host $host;
 proxy_buffering off;
 }
 WebSocket(탈리) 경로:
문제: 
이전 오류: 
proxy_pass http://tally-relay-server:8765;
 tally-relay-server 호스트 네트워크에서 인식 불가 (Docker DNS 불가).
해결: Host 네트워크 모드에서 
127.0.0.1 사용: 
location /ws/ {
 proxy_pass http://127.0.0.1:8765;
 proxy_http_version 1.1;
 proxy_set_header Upgrade $http_upgrade;
 3
proxy_set_header Connection "upgrade";
 proxy_set_header Host $host;
 }
 9. 
10. 
11. 
HTTPS → HTTP 경로 설정:
 SSL 종료 후 내부 서비스로의 요청이 HTTP로 흘러야 함.
 proxy_set_header X-Forwarded-Proto $scheme; 추가 권장.
 4.3 설정 적용 및 컨테이너 관리
• 
• 
• 
설정 파일 문법 검사 및 재시작: 
dockerexecnginx-web-servernginx-t
 dockerexecnginx-web-servernginx-sreload
컨테이너 완전 재기동: 
dockerrm-fnginx-web-server
 dockerrun-d--namenginx-web-server--networkhost\-v~/nginx-web/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro\-v/etc/letsencrypt:/etc/letsencrypt:ronginx:alpine
로그 확인: 
dockerlogs--tail20nginx-web-server
 4.4 인증서 자동 갱신 cron 설정
0 3 * * * root certbot renew --quiet --post-hook "docker rm -f nginx-web
server && \
  docker run -d --name nginx-web-server --network host \
    -v ~/nginx-web/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
    -v /etc/letsencrypt:/etc/letsencrypt:ro nginx:alpine"
참고: cron 수정 후 
sudo systemctl restart cron 또는 
행.
 5. 최종 동작 확인 절차
1. 
2. 
HTTPS 접속: 
service cron restart 진
https://returnfeed.net 메인 페이지 정상 표시 확인.
페이지 로딩: 
https://returnfeed.net/tally_test.html 접속 → 카메라 선택 UI 노출 및 영상 플
3. 
레이어 표시.
네트워크 요청:
 4
WHEP: DevTools Network 탭에서 
4. 
5. 
6. 
7. 
8. 
POST /pgm_srt_raw/whep HTTP/201 Created
 WebSocket: Console 창에 
Tally: Connected 메시지 확인.
 ICE 연결:
 chrome://webrtc-internals 접속 → PeerConnection 항목에서 
state: connected 확인.
영상 및 탈리: PC 및 스마트폰(다양한 네트워크 환경)에서 영상 재생 및 테두리 탈리 색상 정상 동작 확인.
 6. 추가 팁 및 권장 사항
• 
• 
• 
• 
TURN 서버 도입: 다양한 NAT 환경 지원을 위해 TURN 서버 설정을 고려.
 MediaMTX 다중 스트림: 여러 카메라 스트림 라우팅 시 
paths 섹션 확장.
모니터링: Portainer 및 로그 수집(ELK Stack 등)으로 안정성 모니터링.
백업: 설정 파일(
 nginx.conf , 
mediamtx.yml )과 인증서 백업 주기 권장.
이 매뉴얼이 ReturnFeed 라이브 시스템의 설치, 운영, 그리고 문제 해결에 유익한 지침이 되길 바랍니다